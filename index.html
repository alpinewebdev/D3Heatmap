<!doctype html>
<html>

	<head>
	
		<meta charset="UTF-8" />
		<meta name="description" content="A heatmap made with D3" />
		<meta name="keywords" content="datadriven documents D3 javascript library heatmap" />
		<meta name="author" content="Nikolai Riedel" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

		<link rel="stylesheet" type="text/css" href="index.css">
		<link href="https://fonts.googleapis.com/css?family=Lora" rel="stylesheet">
		<script src="https://d3js.org/d3.v4.js"></script>
		
		
	</head>


	<body>
	
		<div id="graphGraphContainer">
			<svg id="graphContainer">
			</svg>
		</div>
	
		<script type="text/javascript">
		
			(function(){
				
				
				if(typeof d3 !== "undefined"){	
					
					const height = document.getElementById("graphGraphContainer").clientHeight;
					const width = document.getElementById("graphGraphContainer").clientWidth;
					
					const margin = {
							top: 150,
							bottom: 100,
							right: 150,
							left: 150
					}
					
					const graphHeight = height - margin.top - margin.bottom;
					const graphWidth = width - margin.right - margin.left;
					
					let yValues = ["January", "February", "March", "April", "May", "June", "Juli", "August", "September", "October", "November", "December"];

					let xScale = d3.scaleBand()
				 				   .range([0, graphWidth])
				 				   .paddingInner(0.01);
					
 					let yScale = d3.scaleBand()
					 				   .range([0, graphHeight])
					 				   .paddingInner(0.005);
					
					let chart = d3.select("#graphContainer")
								    .attr("width", width)
								    .attr("height", height)
					 			  .append("g")
					 			    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
					
					let showDetails = function(d){
						
						let textDetails = chart.append("g")
						   .attr("class", "detailsPopup")
						   .attr("id", "popup" + d.year + "" + d.month)
						   .attr("transform", "translate(" + xScale(d.year) + "," + (yScale(yValues[d.month - 1])) +")")
						   .attr("width", "10rem")
						   .attr("height", "5rem");
					
						textDetails.append("rect")
							         .attr("width", "10rem")
							         .attr("height", "4.3rem");
					
					
						let text = textDetails.append("text")
							   	     		    .attr("id", "popupDetails")
							   	     		    .attr("dy", "1rem");
					
					    text.append("tspan")
					    	  .attr("x", 10)
					    	  .attr("dy", "1.5rem")
					    	  .attr("font-size", "1rem")
							  .attr("fill", "black")
							.text(yValues[d.month - 1] + " - " + d.year);
				    
					    text.append("tspan")
					    	  .attr("x", 10)
					    	  .attr("dy", "1rem")
					    	  .attr("font-size", "1rem")
							  .attr("fill", "black")
					    	.text("Avg. Temp.: " + (8.66 + d.variance).toFixed(2) + " °C");
				    
					    text.append("tspan")
					    	  .attr("x", 10)
		    		     	  .attr("dy", "1rem")
					    	  .attr("font-size", "1rem")
							  .attr("fill", "black")
		    		     	.text("Var.: " + d.variance.toFixed(2) + " °C");					    			
						
					};
					
					let hideDetails = function(d){
						document.getElementById("popup" + d.year + "" + d.month).remove();
					};
					
					
				    d3.json("https://raw.githubusercontent.com/FreeCodeCamp/ProjectReferenceData/master/global-temperature.json", function(error, data){
				    	
				    	if (error) throw error;
				    	
				    	console.log(data);
				    	
				    	data.monthlyVariance.forEach(function(d){
				    		d.year = +d.year;
				    		d.month = +d.month;
				    		d.variance = +d.variance;
				    	});
				    	
				    	let xDomainArr = [];
				    	data.monthlyVariance.forEach(function(d, i){
				    		if(d.month % 7 === 0) xDomainArr.push(d.year);
				    	});
				    	
				    	let yDomainArr = [];
				    	data.monthlyVariance.some(function(d, i){
				    		if(i > 11 && d.month < 2) return true;
				    		yDomainArr.push(yValues[i]);
				    	});
				    	
				    	let variance = [];
				    	data.monthlyVariance.forEach(function(d){
				    		variance.push(d.variance);
				    	});
				    	variance.sort(function(b, a) {return b - a;});
				    	
				    	let colorScale = d3.scaleLinear()
								    	     .range([0, 255])
								    		 .domain([-6.976, d3.max(variance, function(d){return d;})]);
				    	
				    	xScale.domain(xDomainArr);
						yScale.domain(yDomainArr);
				    	
						
						let xAxis = d3.axisBottom()
									    .scale(xScale)
									    .tickValues(xScale.domain().filter(function(d, i){
									    	if(d % 15 === 0) return d;
									    }));
						
						let yAxis = d3.axisLeft()
									    .scale(yScale);
				    	
				    	
				    	chart.append("g")
				    		   .attr("transform", "translate(0 ," + (graphHeight) + ")")
				    		   .attr("class", "x axis")
				    		   .attr("font-size", "1.5rem")
				    		   .attr("height", "100")
				    		   .call(xAxis)
				    		 .append("text")
				    		   .attr("id", "xAxisText")
				    		   .attr("fill", "black")
				    		   .attr("font-size", "1.5rem")
				    		   .attr("transform", "translate(" + (graphWidth / 2) + "," + 55 + ")")
				    		   .text("Year");
				    	      
				    	
				    	chart.append("g")
				    		   .attr("transform", "translate(0, 0 )")
				    		   .attr("class", "y axis")
				    		   .call(yAxis);

				    	 chart.selectAll(".bar")
				    	         .data(data.monthlyVariance)
				    	       .enter().append("rect")
				    	         .attr("fill", function(d){return "rgb(" + Math.floor(colorScale(d.variance)) + "," + (255 - Math.floor(colorScale(d.variance))) + "," + (255 - Math.floor(colorScale(d.variance))) + ")"; })
				    	         .attr("id", function(d){return "id" + d.year + "" + d.month;})
				    	         .attr("x", function(d){return xScale(d.year);})
				    	         .attr("y", function(d){return yScale(yValues[d.month - 1]);})
				    	         .attr("width", function(d){return xScale.bandwidth();})
				    	         .attr("height", function(d){return yScale.bandwidth();})
				    	 	     .on("mouseenter", showDetails)
				    	 	     .on("mouseleave", hideDetails);
				    	 
				    	 chart.append("text")
				    	 	    .attr("x", graphWidth / 2)
				    	 	    .attr("y", -80)
				    	 	    .attr("text-anchor", "middle")
				    	 	    .attr("font-size", "3em")
				    	 	    .text("Monthly Global Land-Surface Temperature");
				    	 
				    	 chart.append("text")
				    	 	    .attr("x", graphWidth / 2)
				    	 	    .attr("y", -50)
				    	 	    .attr("text-anchor", "middle")
				    	 	    .attr("font-size", "2rem")
				    	 	    .text("1753 - 2015");
				    	 
				    	 chart.append("text")
				    	 	    .attr("x", graphWidth / 2)
				    	 	    .attr("y", -25)
				    	 	    .attr("text-anchor", "middle")
				    	 	    .attr("font-size", "1rem")
				    	 	    .text("Temperatures are in Celsius and reported as difference to the Jan 1951-Dec 1980 average.");
				    	 chart.append("text")
				    	 	    .attr("x", graphWidth / 2)
				    	 	    .attr("y", -10)
				    	 	    .attr("text-anchor", "middle")
				    	 	    .attr("font-size", "1rem")
								.text("The average Jan 1951-Dec 1980 absolute temperature is T[℃]: 8.66 +/- 0.07")
				    	
				    	 let legendValues = [{val: -7, index: 1},
		    	        	   				 {val: -3, index: 2},
		    	        	   				 {val: 0, index: 3},
		    	        	   				 {val: 3, index: 4},
		    	        	   				 {val: 5, index: 5}];
				    	 	    
				    	 let legend = chart.append("g")
				    	        .attr("transform", "translate(" + (graphWidth - (graphWidth / 13 * 6)) + "," + (graphHeight + 40) + ")");
				    	 
				    	 legend.selectAll(".legendColors")
				    	        .data(legendValues)
				    	        .enter().append("rect")
				    	          .attr("fill", function(d){return "rgb(" + Math.floor(colorScale(d.val)) + "," + (255 - Math.floor(colorScale(d.val))) + "," + (255 - Math.floor(colorScale(d.val))) + ")"; })
				    	          .attr("id", function(d){return "idLegend" + d.val;})
				    	          .attr("x", function(d){return (d.index * graphWidth / 13)})
				    	          .attr("y", 0)
				    	          .attr("width", (graphWidth / 13))
				    	          .attr("height", "1.2rem");
				    	 
				    	 legendValues.forEach(function(d,i){
				    		 if(i === 0){
				    			 legend.append("text")
		    	         	     .attr("fill", "black")
		    	                 .attr("y", 35)
		    	                 .attr("x", d.index * (graphWidth / 13) + (graphWidth / 26))
		    	                 .attr("text-anchor", "middle")
		    	                 .text("ΔT = " + d.val + "°C");
				    		 } else {
				    			 legend.append("text")
		    	         	     .attr("fill", "black")
		    	                 .attr("y", 35)
		    	                 .attr("x", d.index * (graphWidth / 13) + (graphWidth / 26))
		    	                 .attr("text-anchor", "middle")
		    	                 .text(d.val + "°C");
				    		 }
				    		 
				    	 });  
				    	
				    	
				    });
					
					
				} else {
					alert("The D3 library is either not supported by your browser or did not load correctly!");
				}
				
				
				
			})();
		
		
		</script>
	
	
	
	</body>

</html>